image: 
  name: gcr.io/kaniko-project/executor:v1.14.0-debug
  entrypoint: [""]

stages:
  - build-spring
  - build-mysql
  - build-react
  - deploy

build-spring:
  stage: build-spring
  script:
    - |
      if [[ "$CI_COMMIT_BRANCH" == "docker" ]]; then
        /kaniko/executor --context "./spring" --destination "${CI_REGISTRY_IMAGE}:spring"
      fi
  only:
    changes:
      - spring/*

build-mysql:
  stage: build-mysql
  script:
    - |
      if [[ "$CI_COMMIT_BRANCH" == "docker" ]]; then
        /kaniko/executor --context "./mysql" --destination "${CI_REGISTRY_IMAGE}:mysql"
      fi
  only:
    changes:
      - mysql/*

build-react:
  stage: build-react
  script:
    - |
      if [[ "$CI_COMMIT_BRANCH" == "docker" ]]; then
        /kaniko/executor --context "./react" --destination "${CI_REGISTRY_IMAGE}:react"
      fi
  only:
    changes:
      - react/*

deploy:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: ['']
  script:
    - kubectl config get-contexts
    - kubectl get pods
