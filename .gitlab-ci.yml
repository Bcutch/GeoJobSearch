# Define the stages of the CI pipeline
stages:
  - build
  - react_analysis
  - spring_analysis
  - python_analysis

# Set environment variables or configuration options
variables:
  # Disable Gradle Daemon to avoid potential issues with CI environment
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  JACOCO_CSV_LOCATION: "spring/build/reports/jacoco/test/jacocoTestReport.csv"

# Define the build stage
build:
  stage: build
  image: eclipse-temurin
  # Script to execute for the build stage
  script:
    - cd spring
    # Execute Gradle build excluding tests, runs pmd here for linting
    - ./gradlew build -x test
  # Define artifacts to be preserved from this stage
  artifacts:
    paths:
      # Specify the path to the generated JAR file
      - spring/build/libs/*.jar

react_analysis:
  stage: react_analysis
  image: node:latest
  script:
    - cd react
    - npm install
    - npm run lint
  allow_failure: true

spring_analysis:
  stage: spring_analysis
  image: eclipse-temurin
  script:
    - cd spring
    - ./gradlew test
  artifacts:
    paths:
      - spring/build/jacocoHtml/index.html

python_analysis:
  stage: python_analysis
  image: python:3.11
  services:
    - name: selenium/standalone-chrome
      alias: selenium
  variables:
    SELENIUM_SERVER_URL: "http://selenium:4444/wd/hub"
  before_script:
    - apt-get update -qq && apt-get install -y -qq netcat
    - while ! nc -z selenium 4444; do sleep 1; done
  script:
    - cd python
    - pip install -r requirements.txt
    - export PYTHONPATH=./
    - pytest test_scrapingBot.py
    - pytest test_scrapingBot.py --cov
