image: 
  name: gcr.io/kaniko-project/executor:v1.14.0-debug
  entrypoint: [""]

stages:
  - build
  - deploy

build-spring:
  stage: build
  script:
    - /kaniko/executor --context "./spring" --destination "${CI_REGISTRY_IMAGE}/spring:v0.0.0"
  rules:
    - if: $CI_COMMIT_BRANCH == "deploy"
      changes:
        - spring/**/*

build-mysql:
  stage: build
  script:
    - /kaniko/executor --context "./mysql" --destination "${CI_REGISTRY_IMAGE}/mysql:v0.0.0"
  rules:
    - if: $CI_COMMIT_BRANCH == "deploy"
      changes:
        - mysql/**/*

build-react:
  stage: build
  script:
    - /kaniko/executor --context "./react" --destination "${CI_REGISTRY_IMAGE}/react:v0.0.0"
  rules:
    - if: $CI_COMMIT_BRANCH == "deploy"
      changes:
        - react/**/*

build-blog:
  stage: build
  script:
    - /kaniko/executor --context "./blog" --destination "${CI_REGISTRY_IMAGE}/blog:v0.0.6"
  rules:
    - if: $CI_COMMIT_BRANCH == "deploy"
      changes:
        - blog/**/*

deploy-spring-socs:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: ['']
  script:
    - kubectl config get-contexts
    - kubectl config use-context amerch04/springtemplate:socs
    - kubectl get pods
    - kubectl apply -f k8s/spring/spring-deployment.yaml
  rules:
    - if: '$CI_COMMIT_BRANCH == "deploy"'

deploy-mysql-socs:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: ['']
  script:
    - kubectl config get-contexts
    - kubectl config use-context amerch04/springtemplate:socs
    - kubectl get pods
    - kubectl apply -f k8s/mysql/mysql-deployment.yaml
  rules:
    - if: '$CI_COMMIT_BRANCH == "deploy"'

deploy-react-socs:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: ['']
  script:
    - kubectl config get-contexts
    - kubectl config use-context amerch04/springtemplate:socs
    - kubectl get pods
    - kubectl apply -f k8s/react/react-deployment.yaml
  rules:
    - if: '$CI_COMMIT_BRANCH == "deploy"'

deploy-blog-socs:
  stage: deploy
  image:
    name: bitnami/kubectl:latest
    entrypoint: ['']
  script:
    - kubectl config get-contexts
    - kubectl config use-context amerch04/springtemplate:socs
    - kubectl get pods
    - kubectl apply -f k8s/blog/blog-deployment.yaml
  rules:
    - if: '$CI_COMMIT_BRANCH == "deploy"'